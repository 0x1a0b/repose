#!/usr/bin/env groovy

properties([
        buildDiscarder(logRotator(numToKeepStr: '14')),
        pipelineTriggers([cron('H H(0-7) * * *')]),
        parameters([string(
                defaultValue: "",
                description: "Optional - Extra options to add to the end of the ansible-playbook command.",
                name: "extraOptions")])
])

stage("Performance Test") {
    // current list of performance tests to run (with the optional scripting language if applicable)
    def perfTests = []
    node('performance') {
        checkout scm
        dir('repose-aggregator/tests/performance-tests/test_vars') {
            perfTests = sh(returnStdout: true, script: "find . -type f -name '*.yml' | sed 's/\\.\\///' | sed 's/\\.yml//'").split("\n")
        }
    }

    def performanceJenkinsJob = "performance-test"
    def performanceTestParam = "perf_test"
    def extraOptionsParam = "extra_options"

    def jobsToRun = [:]

    for (int index = 0; index < perfTests.size(); index++) {
        def perfTest = perfTests[index]
        jobsToRun[perfTest] = {
            retry(3) {
                build(job: performanceJenkinsJob, parameters: [
                        [$class: "StringParameterValue", name: performanceTestParam, value: perfTest],
                        [$class: "StringParameterValue", name: extraOptionsParam, value: params.extraOptions]])
            }
        }
    }

    // starts the list of jobs to build in parallel
    parallel(jobsToRun)
}
